<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微前端 | fe-knowledge</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icon.jpg">
    <meta name="description" content="前端相关知识点">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.f0e918df.js" as="script"><link rel="preload" href="/assets/js/2.258b798c.js" as="script"><link rel="preload" href="/assets/js/18.3b2e27e2.js" as="script"><link rel="prefetch" href="/assets/js/10.418684a0.js"><link rel="prefetch" href="/assets/js/11.69af16aa.js"><link rel="prefetch" href="/assets/js/12.12d7e938.js"><link rel="prefetch" href="/assets/js/13.ff1a0c7e.js"><link rel="prefetch" href="/assets/js/14.c5866858.js"><link rel="prefetch" href="/assets/js/15.28e13cf6.js"><link rel="prefetch" href="/assets/js/16.852ecb28.js"><link rel="prefetch" href="/assets/js/17.79ac0184.js"><link rel="prefetch" href="/assets/js/19.a74a826d.js"><link rel="prefetch" href="/assets/js/20.12b7a619.js"><link rel="prefetch" href="/assets/js/21.2f53d391.js"><link rel="prefetch" href="/assets/js/22.2b88494e.js"><link rel="prefetch" href="/assets/js/23.7803bfab.js"><link rel="prefetch" href="/assets/js/24.f2fe1489.js"><link rel="prefetch" href="/assets/js/25.3e2cdcb8.js"><link rel="prefetch" href="/assets/js/26.909599e9.js"><link rel="prefetch" href="/assets/js/27.f4b68361.js"><link rel="prefetch" href="/assets/js/28.8f2724bd.js"><link rel="prefetch" href="/assets/js/29.e8b4befd.js"><link rel="prefetch" href="/assets/js/3.9213ddd6.js"><link rel="prefetch" href="/assets/js/30.1d95c033.js"><link rel="prefetch" href="/assets/js/31.0284d11b.js"><link rel="prefetch" href="/assets/js/32.91d88d19.js"><link rel="prefetch" href="/assets/js/33.d8dabf08.js"><link rel="prefetch" href="/assets/js/34.1e76faa7.js"><link rel="prefetch" href="/assets/js/35.d2b86514.js"><link rel="prefetch" href="/assets/js/36.ca68b080.js"><link rel="prefetch" href="/assets/js/37.7ce64426.js"><link rel="prefetch" href="/assets/js/38.15ce212e.js"><link rel="prefetch" href="/assets/js/39.7fa0cea6.js"><link rel="prefetch" href="/assets/js/4.1ffe3afd.js"><link rel="prefetch" href="/assets/js/40.930daa35.js"><link rel="prefetch" href="/assets/js/41.56c39369.js"><link rel="prefetch" href="/assets/js/42.5df86eba.js"><link rel="prefetch" href="/assets/js/43.1ffc49ae.js"><link rel="prefetch" href="/assets/js/44.3a467794.js"><link rel="prefetch" href="/assets/js/5.27785fb1.js"><link rel="prefetch" href="/assets/js/6.f276b0ab.js"><link rel="prefetch" href="/assets/js/7.8adee903.js"><link rel="prefetch" href="/assets/js/8.4676c7b8.js"><link rel="prefetch" href="/assets/js/9.d22fd14c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">fe-knowledge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/httpsxiao" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/httpsxiao" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/笔记/" class="sidebar-heading clickable"><span>笔记</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js-api/" class="sidebar-heading clickable"><span>api实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/typescript/" class="sidebar-heading clickable"><span>typescript</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/微前端/" class="sidebar-heading clickable open"><span>微前端</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/微前端/微前端.html" class="active sidebar-link">微前端</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/网络/" class="sidebar-heading clickable"><span>网络</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/算法/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微前端"><a href="#微前端" class="header-anchor">#</a> 微前端</h1> <h2 id="_1-什么是微前端"><a href="#_1-什么是微前端" class="header-anchor">#</a> 1 什么是微前端？</h2> <p>微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。即将前端应用拆分成多个可以独立开发部署的子应用，之后由主应用进行聚合控制。</p> <p>主要有以下几个特点：</p> <ul><li><p><strong>技术栈无关</strong>
主框架不限制接入应用的技术栈，微应用具备完全自主权</p></li> <li><p><strong>独立开发、独立部署</strong>
微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新</p></li> <li><p><strong>增量升级</strong>
在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略</p></li> <li><p><strong>独立运行时</strong>
每个微应用之间状态隔离，运行时状态不共享</p></li></ul> <p>微前端架构旨在解决单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用(Frontend Monolith)后，随之而来的应用不可维护的问题。</p> <h2 id="_2-转态隔离"><a href="#_2-转态隔离" class="header-anchor">#</a> 2 转态隔离</h2> <p>状态隔离主要是将各个子应用的 js、css 进行隔离。</p> <h3 id="_2-1-iframe"><a href="#_2-1-iframe" class="header-anchor">#</a> 2.1 iframe</h3> <p>iframe 天然支持 js 和 css 的隔离，但是现在主流微前端框架全部放弃使用 iframe。</p> <p>引用微前端框架 <a href="https://github.com/umijs/qiankun" target="_blank" rel="noopener noreferrer">qiankun<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的介绍：</p> <blockquote><p>如果不考虑体验问题，iframe 几乎是最完美的微前端解决方案了。</p> <p>iframe 最大的特性就是提供了浏览器原生的硬隔离方案，不论是样式隔离、js 隔离这类问题统统都能被完美解决。但他的最大问题也在于他的隔离性无法被突破，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。</p> <p>1、url 不同步。浏览器刷新 iframe url 状态丢失、后退前进按钮无法使用。
2、UI 不同步，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中..
3、全局上下文完全隔离，内存变量不共享。iframe 内外系统的通信、数据同步等需求，主应用的 cookie 要透传到根域名都不同的子应用中实现免登效果。
4、慢。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程。</p> <p>其中有的问题比较好解决(问题1)，有的问题我们可以睁一只眼闭一只眼(问题4)，但有的问题我们则很难解决(问题3)甚至无法解决(问题2)，而这些无法解决的问题恰恰又会给产品带来非常严重的体验问题， 最终导致我们舍弃了 iframe 方案。</p></blockquote> <h3 id="_2-2-js-沙箱"><a href="#_2-2-js-沙箱" class="header-anchor">#</a> 2.2 js 沙箱</h3> <p>JS 沙箱简单点说就是，主应用有一套全局环境 window，子应用有一套假的私有的全局环境 Window，子应用所有操作都子应用全局上下文中生效。</p> <h4 id="_2-2-1-快照沙箱-snapshotsandbox"><a href="#_2-2-1-快照沙箱-snapshotsandbox" class="header-anchor">#</a> 2.2.1 快照沙箱 - snapshotSandbox</h4> <p>快照沙箱就是在应用沙箱挂载和卸载的时候记录全局变量的快照，在应用切换的时候依据快照恢复环境。</p> <p>快照代码实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> snapshot <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> cacheStatus <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mountSnapshotSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  snapshot <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 保存当前快照</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    snapshot<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 恢复之前加载的子应用修改过的转态</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>cacheStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cacheStatus<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">unmountSnapshotSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cacheStatus <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 根据快照恢复 window</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> snapshot<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 保存当前子应用修改的状态，下次再加载时恢复</span>
      cacheStatus<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> snapshot<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">mountSnapshotSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token number">1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token comment">// 1</span>

<span class="token function">unmountSnapshotSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token function">mountSnapshotSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>优点</strong>: 兼容几乎所有浏览器</p> <p><strong>缺点</strong>: 无法同时有多个运行时快照沙箱，否则在 window 上修改的记录会混乱，一个页面只能运行一个单实例微应用</p> <h4 id="_2-2-2-代理沙箱-proxysandbox"><a href="#_2-2-2-代理沙箱-proxysandbox" class="header-anchor">#</a> 2.2.2 代理沙箱 - proxySandbox</h4> <p>代理沙箱，是通过 ES6 的 proxy 特性实现的。每个子应用 js 都仅在自己的代理沙箱生效。</p> <p>代码实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> rawAddEventListener <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
<span class="token keyword">const</span> rawSetTimeout <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createProxySandbox</span><span class="token punctuation">(</span><span class="token parameter">fakeWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fakeWindow<span class="token punctuation">.</span>addEventListener <span class="token operator">=</span> rawAddEventListener
  fakeWindow<span class="token punctuation">.</span>setTimeout <span class="token operator">=</span> rawSetTimeout

  <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
  _this<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  _this<span class="token punctuation">.</span><span class="token function-variable function">mountProxySandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    _this<span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  _this<span class="token punctuation">.</span><span class="token function-variable function">unmountProxySandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    _this<span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> proxySandbox1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">createProxySandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> proxySandbox2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">createProxySandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> box1js <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  window.test = 1;
  console.log('box1 test is ' + window.test);
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> box2js <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  window.test = 2;
  console.log('box2 test is ' + window.test);
</span><span class="token template-punctuation string">`</span></span>
proxySandbox1<span class="token punctuation">.</span><span class="token function">mountProxySandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
proxySandbox2<span class="token punctuation">.</span><span class="token function">mountProxySandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">run</span><span class="token punctuation">(</span>box1js<span class="token punctuation">,</span> proxySandbox1<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token comment">// 1</span>
<span class="token function">run</span><span class="token punctuation">(</span>box2js<span class="token punctuation">,</span> proxySandbox2<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token comment">// 2</span>

proxySandbox1<span class="token punctuation">.</span><span class="token function">unmountProxySandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">run</span><span class="token punctuation">(</span>box1js<span class="token punctuation">,</span> proxySandbox1<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">jsStr<span class="token punctuation">,</span> fakeWindow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    ;((function(window) {
      with(window) {
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      }
    }))(fakeWindow)
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>优点</strong>:</p> <ul><li>可同时运行多个沙箱</li> <li>不会污染 window 环境</li></ul> <p><strong>缺点</strong>:</p> <ul><li>不兼容 ie</li> <li>使用 var 或 function 声明的变量和函数无法被代理沙箱劫持，只能通过 window.xxx 设置或者不使用 var，直接声明</li></ul> <h3 id="_2-3-css-隔离"><a href="#_2-3-css-隔离" class="header-anchor">#</a> 2.3 css 隔离</h3> <h4 id="_2-3-1-动态样式表"><a href="#_2-3-1-动态样式表" class="header-anchor">#</a> 2.3.1 动态样式表</h4> <p>加载 A 子应用时使用 A 的样式表，加载 B 子应用时使用 B 的样式表，</p> <p><strong>优点：</strong></p> <ul><li>简单、不会冲突</li></ul> <p><strong>缺点：</strong></p> <ul><li>无法多个子应用共存</li></ul> <h4 id="_2-3-2-bem-block-element-modifier"><a href="#_2-3-2-bem-block-element-modifier" class="header-anchor">#</a> 2.3.2 BEM Block-Element-Modifier</h4> <p>不同项目用不同的前缀命名</p> <p><strong>优点：</strong></p> <ul><li>简单</li></ul> <p><strong>缺点：</strong></p> <ul><li>依赖不同团队之间的约定，容易出错</li></ul> <h4 id="_2-3-3-css-modules"><a href="#_2-3-3-css-modules" class="header-anchor">#</a> 2.3.3 CSS Modules</h4> <p>通过编译时生成不同的选择器名</p> <p><strong>优点：</strong></p> <ul><li>避免人工约束，简单</li></ul> <p><strong>缺点：</strong></p> <ul><li>需要在子应用构建的时候约束使用工具构建</li></ul> <h4 id="_2-3-4-css-in-js"><a href="#_2-3-4-css-in-js" class="header-anchor">#</a> 2.3.4 CSS-in-JS</h4> <p>css 写在 js 中，由 js 注入控制</p> <p><strong>优点：</strong></p> <ul><li>可以彻底避免冲突</li></ul> <p><strong>缺点：</strong></p> <ul><li>运行时开销较大，而且确实完整 css 的功能</li></ul> <h4 id="_2-3-5-shadow-dom"><a href="#_2-3-5-shadow-dom" class="header-anchor">#</a> 2.3.5 Shadow DOM</h4> <p>Shadow DOM 允许将隐藏的 DOM 树附加到常规的 DOM 树中，DOM 和 CSS 是完全隔离的</p> <p><strong>优点：</strong></p> <ul><li>可以彻底避免冲突</li></ul> <p><strong>缺点：</strong></p> <ul><li>使用弹窗组件的时候 DOM 一般会添加到外层 body 上，样式就会失效</li></ul> <h4 id="_2-3-6-运行时转换样式-runtime-css-transformer"><a href="#_2-3-6-运行时转换样式-runtime-css-transformer" class="header-anchor">#</a> 2.3.6 运行时转换样式 - runtime css transformer</h4> <p>动态运行时地去改变 CSS ，比如 A 应用的一个样式 p.title，转换后会变成 div[data-A] p.title。</p> <p>div[data-A] 是微应用最外层的容器节点，故保证 A 应用的样式只有在 div[data-A] 下生效。</p> <p>实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// scopedCSS.js</span>
<span class="token keyword">function</span> <span class="token function">scopeCss</span><span class="token punctuation">(</span><span class="token parameter">styleNode<span class="token punctuation">,</span> prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token function">ruleStyle</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>sheet<span class="token punctuation">.</span>cssRules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  styleNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> css<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ruleStyle</span><span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rootSelectorRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">((?:[^\w\-.#]|^)(body|html|:root))</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span> cssText <span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>

  <span class="token comment">// 绑定选择器, a,span,p,div { ... }</span>
  cssText <span class="token operator">=</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\s\S]+{</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">selectors</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    selectors<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(^|,\n?)([^,]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> p<span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 绑定 div,body,span { ... }</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rootSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rootSelectorRE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不要丢失有效字符 如 body,html or *:not(:root)</span>
          <span class="token keyword">const</span> whitePrevChars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&amp;&amp;</span> whitePrevChars<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 用前缀替换根选择器</span>
          <span class="token keyword">return</span> prefix<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^ *</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> cssText<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>使用：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">p.title</span> <span class="token punctuation">{</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">data-qiankun-A</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>一行文字<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scopedCSS.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> styleNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;style&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">scopeCss</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">,</span> <span class="token string">&quot;body[data-qiankun-A]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>优点：</strong></p> <ul><li>支持大部分样式隔离需求</li> <li>解决了 Shadow DOM 方案导致的丢失根节点问题</li></ul> <p><strong>缺点：</strong></p> <ul><li>运行时重新加载样式，会有一定性能损耗</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">8/14/2021, 3:33:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/typescript/type-vs-interface.html" class="prev">
        type vs interface
      </a></span> <span class="next"><a href="/网络/https.html">
        https
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0e918df.js" defer></script><script src="/assets/js/2.258b798c.js" defer></script><script src="/assets/js/18.3b2e27e2.js" defer></script>
  </body>
</html>
