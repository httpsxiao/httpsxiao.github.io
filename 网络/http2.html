<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>http2 | fe-knowledge</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/icon.jpg">
    <meta name="description" content="前端相关知识点">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.f0e918df.js" as="script"><link rel="preload" href="/assets/js/2.258b798c.js" as="script"><link rel="preload" href="/assets/js/40.930daa35.js" as="script"><link rel="prefetch" href="/assets/js/10.418684a0.js"><link rel="prefetch" href="/assets/js/11.69af16aa.js"><link rel="prefetch" href="/assets/js/12.12d7e938.js"><link rel="prefetch" href="/assets/js/13.ff1a0c7e.js"><link rel="prefetch" href="/assets/js/14.c5866858.js"><link rel="prefetch" href="/assets/js/15.28e13cf6.js"><link rel="prefetch" href="/assets/js/16.852ecb28.js"><link rel="prefetch" href="/assets/js/17.79ac0184.js"><link rel="prefetch" href="/assets/js/18.3b2e27e2.js"><link rel="prefetch" href="/assets/js/19.a74a826d.js"><link rel="prefetch" href="/assets/js/20.12b7a619.js"><link rel="prefetch" href="/assets/js/21.2f53d391.js"><link rel="prefetch" href="/assets/js/22.2b88494e.js"><link rel="prefetch" href="/assets/js/23.7803bfab.js"><link rel="prefetch" href="/assets/js/24.f2fe1489.js"><link rel="prefetch" href="/assets/js/25.3e2cdcb8.js"><link rel="prefetch" href="/assets/js/26.909599e9.js"><link rel="prefetch" href="/assets/js/27.f4b68361.js"><link rel="prefetch" href="/assets/js/28.8f2724bd.js"><link rel="prefetch" href="/assets/js/29.e8b4befd.js"><link rel="prefetch" href="/assets/js/3.9213ddd6.js"><link rel="prefetch" href="/assets/js/30.1d95c033.js"><link rel="prefetch" href="/assets/js/31.0284d11b.js"><link rel="prefetch" href="/assets/js/32.91d88d19.js"><link rel="prefetch" href="/assets/js/33.d8dabf08.js"><link rel="prefetch" href="/assets/js/34.1e76faa7.js"><link rel="prefetch" href="/assets/js/35.d2b86514.js"><link rel="prefetch" href="/assets/js/36.ca68b080.js"><link rel="prefetch" href="/assets/js/37.7ce64426.js"><link rel="prefetch" href="/assets/js/38.15ce212e.js"><link rel="prefetch" href="/assets/js/39.7fa0cea6.js"><link rel="prefetch" href="/assets/js/4.1ffe3afd.js"><link rel="prefetch" href="/assets/js/41.56c39369.js"><link rel="prefetch" href="/assets/js/42.5df86eba.js"><link rel="prefetch" href="/assets/js/43.1ffc49ae.js"><link rel="prefetch" href="/assets/js/44.3a467794.js"><link rel="prefetch" href="/assets/js/5.27785fb1.js"><link rel="prefetch" href="/assets/js/6.f276b0ab.js"><link rel="prefetch" href="/assets/js/7.8adee903.js"><link rel="prefetch" href="/assets/js/8.4676c7b8.js"><link rel="prefetch" href="/assets/js/9.d22fd14c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">fe-knowledge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/httpsxiao" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/httpsxiao" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/笔记/" class="sidebar-heading clickable"><span>笔记</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js-api/" class="sidebar-heading clickable"><span>api实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/typescript/" class="sidebar-heading clickable"><span>typescript</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/微前端/" class="sidebar-heading clickable"><span>微前端</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/网络/" class="sidebar-heading clickable open"><span>网络</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/网络/https.html" class="sidebar-link">https</a></li><li><a href="/网络/http2.html" class="active sidebar-link">http2</a></li><li><a href="/网络/http3.html" class="sidebar-link">http3</a></li><li><a href="/网络/缓存.html" class="sidebar-link">缓存</a></li><li><a href="/网络/跨域.html" class="sidebar-link">跨域</a></li><li><a href="/网络/攻击.html" class="sidebar-link">攻击</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/算法/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="http2"><a href="#http2" class="header-anchor">#</a> http2</h1> <h2 id="二进制分帧"><a href="#二进制分帧" class="header-anchor">#</a> 二进制分帧</h2> <p>HTTP/2 为什么能在不改动 HTTP/1.x 的语义、方法、状态码以及首部字段等的情况下，改进传输性能，实现低延迟和高吞吐量？</p> <p>关键之一就是在应用层(http2)和传输层(TCP or UDP)之间增加一个二进制分帧层。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>┌───────────────────────────┐
│           HTTP2           │
└─────────────┬─────────────┘       ┌───────────────┐
┌─────────────┴─────────────┐       │  HEADER frame │
│        二进制分帧层         │─────&gt; │───────────────│
└─────────────┬─────────────┘       │  DATA frame   │
┌─────────────┴─────────────┐       └───────────────┘
│            TCP            │
└───────────────────────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在二进制分帧层中，http2 会将所有传输的信息分割为更小的消息和帧（frame），并对它们采用二进制格式的编码。其中 http1.x 的首部信息会被封装到 HEADER frame，而相应的 Request Body 则封装到 DATA frame 里面</p> <p>http1.x 诞生的时候是明文协议，基于文本协议的格式解析要做到健壮性考虑的场景必然很多。基于这种考虑 http2.0 的协议解析决定采用二进制格式，二进制只认 0 和 1 的组合。实现方便且健壮。</p> <p>http1.x 信息组成: start line、header、body</p> <p>http2   信息组成: length、type、flags、stream id、payload</p> <h2 id="帧-frame-和流-stream"><a href="#帧-frame-和流-stream" class="header-anchor">#</a> 帧（frame）和流（stream）</h2> <p>帧和流是 http2 的两个核心概念。先介绍几个概念：</p> <blockquote><p>Connection 连接: 1 个 TCP 连接，包含 1 个或者多个 stream。所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。</p> <p>Stream 数据流：一个双向通信的数据流，包含 1 条或者多条 Message。每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。</p> <p>Message 消息：对应 HTTP/1.1 中的请求 request 或者响应 response，包含 1 条或者多条 Frame。</p> <p>Frame 数据帧：最小通信单位，以二进制压缩格式存放内容。来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。</p></blockquote> <h3 id="帧-frame"><a href="#帧-frame" class="header-anchor">#</a> 帧（frame）</h3> <p>所有帧都以固定的 9 字节（72 位）大小的头作为帧开始，后跟可变长度的有效载荷 payload。以下为帧的结构，括号内容为位数。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>┌───────────────────────────────┐
│         Length(24)            │
└─────────────┬─────────────────┘
┌─────────────┴─────────────────┐
│   Type(8)   │   Flags(8)      │
└─────────────┬─────────────────┘
┌─────────────┴─────────────────┐
│ R(1) │ Stream Identifier(31)  │
└─────────────┬─────────────────┘
┌─────────────┴─────────────────┐
│      Frame Payload(any)       │
└───────────────────────────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>各个字段含义：</p> <ul><li>Length</li></ul> <p>表示整个 frame 的长度，用一个 24 位无符号位表示，帧头的 9 个八位字节不包含在此长度值中。</p> <blockquote><p>但是这不意味着就能处理 2^24 大小的帧，除非接收方为 SETTINGS_MAX_FRAME_SIZE 设置了较大的值，否则不得发送大于 2^14（16,384）的值。</p></blockquote> <ul><li>Type</li></ul> <p>定义 frame 的类型。帧类型决定了帧主体的格式和语义，如果 type 为 unknown 应该忽略或抛弃。</p> <table><thead><tr><th>帧类型</th> <th>编码类型</th> <th>用途</th></tr></thead> <tbody><tr><td>DATA</td> <td>0x0</td> <td>传递HTTP包体</td></tr> <tr><td>HEADERS</td> <td>0x1</td> <td>传递HTTP包头</td></tr> <tr><td>PRIORITY</td> <td>0x2</td> <td>指定Stream 流的优先级</td></tr> <tr><td>RST_STREAM</td> <td>0x3</td> <td>终止Stream流</td></tr> <tr><td>SETTINGS</td> <td>0x4</td> <td>修改连接或者Stream流的配置</td></tr> <tr><td>PUSH_PROMISE</td> <td>0x5</td> <td>服务端推送资源时描述请求的帧</td></tr> <tr><td>PING</td> <td>0x6</td> <td>心跳监测兼具测量RTT的功能</td></tr> <tr><td>GOAWAY</td> <td>0x7</td> <td>优雅的终止错误或通知错误</td></tr> <tr><td>WINDOW_UPDATE</td> <td>0x8</td> <td>实现流量控制</td></tr> <tr><td>CONTINUATION</td> <td>0x9</td> <td>传递较大HTTP头部时的持续帧</td></tr></tbody></table> <ul><li>Flags</li></ul> <p>为帧类型相关而预留的布尔标识。标识对于不同的帧类型赋予了不同的语义。</p> <ul><li>R</li></ul> <p>是一个保留的比特位。这个比特的语义没有定义，发送时它必须被设置为 (0x0), 接收时需要忽略。</p> <ul><li>Stream Identifier</li></ul> <p>流标识符，表示为无符号 31 位整数，用于与整个连接相关联的帧。Stream Identifier 的作用：</p> <ul><li><p>实现多路复用的关键。接收端的实现可以根据这个 ID 并发组装消息。</p></li> <li><p>推送依赖性请求的关键。客户端发起的流是奇数编号，服务端发起的流是偶数编号。</p></li> <li><p>Payload</p></li></ul> <p>request 的正文</p> <h3 id="流-stream"><a href="#流-stream" class="header-anchor">#</a> 流（stream）</h3> <p>流可以看做是 http1.x 里面的每个请求，http2.0 会将每个流分成多个帧进行消息传输，同一个流所有的帧都有相同的 Stream Identifier 用于标识是哪个流，接收方通过帧的 Stream Identifier 将收到的帧组成一整块的流数据。</p> <p>发送方可以为不同的流设置优先级，接收方会先处理优先级更高的流。</p> <h2 id="多路复用-multiplexing"><a href="#多路复用-multiplexing" class="header-anchor">#</a> 多路复用 (Multiplexing)</h2> <p>在过去， HTTP 性能优化的关键并不在于高带宽，而是低延迟。TCP 连接会随着时间进行自我「调谐」，起初会限制连接的最大速度，如果数据成功传输，会随着时间的推移提高传输的速度。这种调谐则被称为 TCP 慢启动。</p> <p>由于这种原因，让原本就具有突发性和短时性的 HTTP 连接变的十分低效。</p> <p>http2.0 通过让所有数据流共用同一个连接，可以更有效地使用 TCP 连接，让高带宽也能真正的服务于 HTTP 的性能提升 ———— 只需要创建一个新流即可，这不需要多少时间。单连接有如下优势：</p> <ol><li>单连接多资源的方式，减少服务端的链接压力，内存占用更少，连接吞吐量更大</li> <li>由于 TCP 连接的减少而使网络拥塞状况得以改善，同时慢启动时间的减少，使拥塞和丢包恢复速度更快</li></ol> <p>在 http1.x 协议中，浏览器客户端在同一时间，针对同一域名下的请求有一定数量限制（这也是为何一些站点会有多个静态资源 CDN 域名的原因之一），超过限制数目的请求会被阻塞。多路复用代替原来的序列和阻塞机制，所有就是请求的都是通过一个 TCP 连接并发完成。</p> <h2 id="首部压缩-header-compression"><a href="#首部压缩-header-compression" class="header-anchor">#</a> 首部压缩（Header Compression）</h2> <p>http1.x 的 header 由于 cookie 和 user agent 很容易膨胀，而且每次都要重复发送。</p> <p>http2.0 采用了 HPACK 压缩算法来压缩头部，通讯双方各自缓存一份 header fields 表(下面会介绍)，避免重复 header 传输并减小了体积。</p> <h3 id="header-fields-表"><a href="#header-fields-表" class="header-anchor">#</a> header fields 表</h3> <p>表中用索引代表头部名称或者键值对，前一次通信双方都会记住已发送过哪些首部，后一次发送只需要传输差异的头部，相同的部分直接用索引表示。如：</p> <table><thead><tr><th>索引</th> <th>头部</th> <th>值</th></tr></thead> <tbody><tr><td>1</td> <td>method</td> <td>GET</td></tr> <tr><td>2</td> <td>scheme</td> <td>https</td></tr> <tr><td>...</td> <td>...</td> <td>...</td></tr></tbody></table> <h2 id="服务端推送-server-push"><a href="#服务端推送-server-push" class="header-anchor">#</a> 服务端推送（Server Push）</h2> <p>http2.0 中，服务端直接给客户端发送数据，而无需客户端先进行请求。服务端推送还可以缓存。</p> <p>但是，与 web socket 双向通信不同。服务器只能主动将资源推送到客户端缓存，并不允许将数据推送到客户端里跑的 Web App 本身。服务端推送对 Web App 是隐藏的，完全由浏览器处理。</p> <h2 id="不断开重连"><a href="#不断开重连" class="header-anchor">#</a> 不断开重连</h2> <p>对于取消请求的操作，</p> <p>http1.x 是通过设置 tcp segment 里的 reset flag 来通知对端关闭连接的，但会导致连接直接断开，下次请求必须重连。</p> <p>http2.0 引入 RST_STREAM 类型的帧(frame)，可以在不断开连接的前提下取消某个请求的流(stream)。</p> <h2 id="ssl-更安全"><a href="#ssl-更安全" class="header-anchor">#</a> SSL 更安全</h2> <ul><li>使用 TLS 的拓展 ALPN 来做协议升级</li> <li>黑名单机制，禁用几百种不再安全的加密算法</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">7/24/2021, 5:02:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/网络/https.html" class="prev">
        https
      </a></span> <span class="next"><a href="/网络/http3.html">
        http3
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0e918df.js" defer></script><script src="/assets/js/2.258b798c.js" defer></script><script src="/assets/js/40.930daa35.js" defer></script>
  </body>
</html>
